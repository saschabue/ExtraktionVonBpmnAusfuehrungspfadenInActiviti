package org.transformBpmnDocumentforRecording.concreteObserver;

import java.util.List;

import org.activiti.bpmn.model.ActivitiListener;
import org.activiti.bpmn.model.BpmnModel;
import org.activiti.bpmn.model.IntermediateCatchEvent;
import org.activiti.bpmn.model.Process;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.transformBpmnDocumentforRecording.transformationLogik.AbstaractLoadObserver;
import org.transformBpmnDocumentforRecording.transformationLogik.HandleBPMNDocuments;

public class AddSignalReceiveLoadObserver extends AbstaractLoadObserver {
	private static Logger log = LoggerFactory.getLogger(AddSignalReceiveLoadObserver.class);

	public AddSignalReceiveLoadObserver(HandleBPMNDocuments handleDocs) {
		super(handleDocs);
	}

	@Override
	protected void addListerToElement(final BpmnModel model) {
		List<Process> processes = model.getProcesses();
		ActivitiListener myListener = createListenerReferenceforXML();
		for (Process process : processes) {

			List<IntermediateCatchEvent> findFlowElementsOfType = process.findFlowElementsOfType(IntermediateCatchEvent.class);
			for (IntermediateCatchEvent intermediateCatchEvent : findFlowElementsOfType) {
				List<ActivitiListener> executionListeners = intermediateCatchEvent.getExecutionListeners();
				boolean listenerExists = false;
				// check existing Listeners, if this type already exists
				for (ActivitiListener activitiListener : executionListeners) {
					if (activitiListener.getImplementation().equals(myListener.getImplementation())) {
						listenerExists = true;
						if (listenerExists) {
							log.error("Prozessdefinition has StartEvent recording listeners already implemented");
						}
					}
				}
				if (!listenerExists) {
					intermediateCatchEvent.getExecutionListeners().add(myListener);
				}
			}
		}
	}

	@Override
	protected ActivitiListener createListenerReferenceforXML() {
		ActivitiListener tli = new ActivitiListener();
		tli.setEvent("end");
		tli.setImplementationType("class");
		tli.setImplementation("org.extraktion.listener.ExecutionListenerImplSignalReceive");
		return tli;
	}
	

}
