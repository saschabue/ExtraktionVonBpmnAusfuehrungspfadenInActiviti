package org;

import java.util.List;

import org.activiti.engine.repository.Deployment;
import org.activiti.engine.runtime.ProcessInstance;
import org.activiti.engine.test.ActivitiRule;
import org.extraktion.TestObjectDesigner;
import org.hibernate.Session;
import org.junit.After;
import org.junit.Rule;

/**
 * @author Sascha Buelles StandardTest to clean up after database after
 *         execution
 */
public class StandardProcessIntegrationTest {
	
	@Rule
	public ActivitiRule activitiRule = new ActivitiRule();

	/**
	 * System Clean Up
	 */
	@After
	public void cleanUp() {
		List<Deployment> deployments = activitiRule.getRepositoryService().createDeploymentQuery().list();

		// Alle aktiven Prozess Instanzen stoppen, danach alle Deployments
		// löschen
		List<ProcessInstance> runningInstances = activitiRule.getRuntimeService().createProcessInstanceQuery().list();
		for (ProcessInstance processInstance : runningInstances) {
			activitiRule.getRuntimeService().deleteProcessInstance(processInstance.getId(), "work");
		}
		for (Deployment deployment : deployments) {
			activitiRule.getRepositoryService().deleteDeployment(deployment.getId());
		}
		Session openSession = TestObjectDesigner.getInstance().getHibernateSessionFactory().openSession();
		openSession.getTransaction().begin();
		
		openSession.createNativeQuery("DELETE FROM EXTRAKTION").executeUpdate();
		
		openSession.close();
		TestObjectDesigner.getInstance().clearAndClose();
		
		
		
	}
}
